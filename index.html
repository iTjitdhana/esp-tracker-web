<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ESP Tracker Horizontal UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="dropdown-wrapper">
    <select id="device-select" onchange="updateFromDropdown()">
      <option value="01">ESP-01</option>
      <option value="02">ESP-02</option>
      <option value="03">ESP-03</option>
      <option value="04">ESP-04</option>
      <option value="05">ESP-05</option>
      <option value="06">ESP-06</option>
      <option value="07">ESP-07</option>
      <option value="08">ESP-08</option>
      <option value="09">ESP-09</option>
      <option value="10">ESP-10</option>
    </select>
  </div>

  <div class="container">
    <div class="display-section">
      <div class="number-display" id="num-display">01</div>
      <div class="process-name" id="process-name">1 | เตรียมอุปกรณ์</div>
      <div class="status-log" id="status-log">ยังไม่ส่งข้อมูล</div>
    </div>

    <div class="controls">
      <button class="btn btn-red" onclick="sendToSheet(false)">หยุดงาน</button>
      <button class="btn btn-green" onclick="sendToSheet(true)">เริ่มงาน</button>
      <div class="btn-select-wrap">
        <button class="btn btn-yellow" onclick="changeNumber(1)">▲</button>
        <button class="btn btn-yellow" onclick="changeNumber(-1)">▼</button>
      </div>
    </div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbz_Vn_RziszH9dGYyqhi9mfBVdPnKXFTU_MK8TyEaTuG-o4i-m064CnKiNC6VPv8lDs/exec";
    const sheetName = "Data";
    let number = 1;

    const processMap = {
      1: "เตรียมอุปกรณ์",
      2: "ชั่งน้ำ ใส่เครื่องปรุง ใส่ซี่โครง รอบที่ 1",
      3: "ตุ๋น 30 นาที, ล้างหม้อ, แพ็ค รอบที่ 1",
      4: "ชั่งน้ำ ใส่เครื่องปรุง ใส่ซี่โครง รอบที่ 2",
      5: "ตุ๋น 30 นาที, ล้างหม้อ, แพ็ค รอบที่ 2",
      6: "ชั่งน้ำ ใส่เครื่องปรุง ใส่ซี่โครง รอบที่ 3",
      7: "ตุ๋น 30 นาที, ล้างหม้อ, แพ็ค รอบที่ 3",
      8: "ชั่งน้ำ ใส่เครื่องปรุง ใส่ซี่โครง รอบที่ 4",
      9: "ตุ๋น 30 นาที, ล้างหม้อ, แพ็ค รอบที่ 4",
      10:"ชั่งน้ำ ใส่เครื่องปรุง ใส่ซี่โครง รอบที่ 5",
      11:"ตุ๋น 30 นาที, ล้างหม้อ, แพ็ค รอบที่ 5",
      12:"ล้างอุปกรณ์"
    };

    function changeNumber(step) {
      number += step;
      if (number > 10) number = 1;
      if (number < 1) number = 10;
      updateDisplay();
    }

    function updateDisplay() {
      document.getElementById("num-display").textContent = number.toString().padStart(2, '0');
      const selectedDevice = document.getElementById("device-select").value;
      const processName = document.getElementById("process-name");

      if (selectedDevice === "10") {
        processName.style.display = "block";
        processName.textContent = `${number} | ${processMap[number] || ""}`;
      } else {
        processName.style.display = "none";
      }
    }

    function updateFromDropdown() {
      updateDisplay();
    }

    function getCurrentTime() {
      const now = new Date();
      return now.toLocaleTimeString('th-TH', { hour12: false });
    }

    function sendToSheet(isStart) {
      const deviceId = `ESP-${document.getElementById("device-select").value}`;
      const timestamp = getCurrentTime();
      const url = `${scriptURL}?number=${number}&timestamp=${timestamp}&sheetName=${sheetName}&deviceId=${deviceId}`;

      const statusLog = document.getElementById("status-log");
      statusLog.className = "status-log";
      statusLog.textContent = `กำลังส่ง (${isStart ? "เริ่มงาน" : "หยุดงาน"})...`;

      fetch(url)
        .then(res => res.text())
        .then(text => {
          statusLog.classList.add(isStart ? "status-success" : "status-fail");
          statusLog.textContent = isStart ? "Start สำเร็จแล้ว" : "Stop สำเร็จแล้ว";
        })
        .catch(err => {
          statusLog.className = "status-log status-fail";
          statusLog.textContent = "❌ เกิดข้อผิดพลาดในการส่งข้อมูล";
          console.error(err);
        });
    }

    updateDisplay();
  </script>
</body>
</html>
